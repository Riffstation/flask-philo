FROM localhost:5000/rfqa/rfqapostgres:v0.0.1
MAINTAINER Rondineli Gomes <rdearaujo@fender.com>

USER postgres

ADD . /src

USER postgres
RUN /etc/init.d/postgresql start && sleep 45 &&\
    psql -c "DROP DATABASE play_riffstation;" || echo "ok"; \
    psql -c "CREATE ROLE riff_dev WITH ENCRYPTED PASSWORD 'dsps'"; \
    psql -c "ALTER ROLE riff_dev WITH ENCRYPTED PASSWORD 'YzY4Y2MwZjRkNDcyOWVhNjYyOTc1MzVh'"; \
    psql -c "ALTER ROLE riff_dev SET client_encoding TO 'utf8';";\
    psql -c "ALTER ROLE riff_dev WITH LOGIN;";\
    psql -c "ALTER ROLE riff_dev SET default_transaction_isolation TO 'read committed';";\
    psql -c "ALTER ROLE riff_dev SET timezone TO 'UTC';";\
    psql -c "CREATE DATABASE play_riffstation;";\
    psql -c "ALTER DATABASE play_riffstation OWNER TO riff_dev;";\
    psql -c "GRANT ALL PRIVILEGES ON DATABASE play_riffstation to riff_dev;";\
    export PGPASSWORD=YzY4Y2MwZjRkNDcyOWVhNjYyOTc1MzVh; /etc/init.d/postgresql start;
ENV PGPASSWORD YzY4Y2MwZjRkNDcyOWVhNjYyOTc1MzVh

EXPOSE 5432

CMD ["/usr/lib/postgresql/9.6/bin/postgres", "-D", "/var/lib/postgresql/9.6/main", "-c", "config_file=/etc/postgresql/9.6/main/postgresql.conf"]
